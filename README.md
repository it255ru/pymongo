# КПЭ 2020

## Термины

ИС ВКД - информационная система виртуальных комнат данных

ИОД - инициатор общего доступа

Отчет - файл в формате xlsx или csv содержащий информацию из базы ИС ВКД для ИОД

## Задание 1:
Отчет "Список пользователей по комнатам одного из ИОД" должен рассылатся ИОДу который запросил отчет. 
  
Пример отчета:
ИОД | ВКД | Владелец ВКД | Пользователи вкд | Email
--- | --- | --- | --- | ---
Кузнецова | ERM:VIEW | Ereminag | User1 | user1@mail.com
Кузнецова | ERM:VIEW | Ereminag | User2 | user2@mail.com
Кузнецова | ERM:VIEW | Ereminag | User3 | user3@mail.com
Кузнецова | ERM:VIEW | Ereminag | User4 | user4@mail.com
Кузнецова | ERM:COPY | Ereminag | User1 | user1@mail.com
Кузнецова | ERM:COPY | Ereminag | User2 | user2@mail.com
Кузнецова | ERM:COPY | Ereminag | User3 | user3@mail.com
 
Описание скрипта: скрипт подлкючается к базе MongoDB без пароля. Ищет во всех документах и коллекциях упоминание электронных адресов с доменным именем ivanov.com или petrov.com.
В найденом ищем имя и фамилию участников поиска.

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import pymongo
import re
import json

db_connect = pymongo.MongoClient('localhost', 27017, maxPoolSize=50)
for db in db_connect.database_names():
    database = db_connect[db]
    collection = database.collection_names(include_system_collections=False)
    for collect in collection:  #list the collections
        cursor = database[collect] # choosing all collection in all db
        regx = re.compile("(\W|^)[\w.\-]{0,25}@(ivanov|petrov)\.com(\W|$)", re.IGNORECASE)
        for x in cursor.find({"email": regx}):
            try:
                print x["nm"], ' found in:  ', db,'/',collect
            except:
                print 'Not found in: ',db,'/',collect
```
[out]: 
<pre>
# /opt/python2.7/bin/python2.7 test.py
Ivan Ivanov  found in:   auth / user
Not found in:  tracking / a
Not found in:  tracking / a
Not found in:  tracking / a
Not found in:  tracking / a
Not found in:  tracking / a
Not found in:  tracking / a
</pre>

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import pymongo

db_connect = pymongo.MongoClient('localhost', 27017, maxPoolSize=50)
db = db_connect['auth']
collection = db['user']
cursor = db['user']
x = cursor.find_one({"nm" : "Ivan Ivanov"})
print x['nm']
```
[out]: 
<pre>
# /opt/python2.7/bin/python2.7 test.py
Ivan Ivanov
</pre>

---

 ## 2. Список задействованных лицензий по пользователям ИОДа
 
Пример 1:
ИОД: Кузнецова
User1..10: email
1 тип. лицензии +
2 тип. лицензии +
3 тип. лицензии +
DRM лицензии -

Пример 2:
ИОД: Кузнецова
Лицензий: 12/50 

Пример 3:
Каманин: 
  - 360 куплено
  - 260 исп.
  - 70 раздал
  - 30 свободных

Луневский:
  - 120 врем. (среди которых без лицензий, существ. аккаунты, новые аккаунты и те кто ни разу не подключился)

---

## 3. Статусы по активности пользователей ИОДа:
### 3.1. Время последнего входа в систему (проверка, что смог авторизоватся)
### 3.2. Доступ к ВКД (проверка, что смог авторизоватся и перешел в одну из комнат)
### 3.3. Доступ к файлу (проверка, что смог авторизоватся и перешел в одну из комнат и скачал или просмотрел файл)

---

## 4. Отчеты по комнатам содержащие информацию с определенным тегом (Кт, ПДн, ИИ)

Допустим есть 10 ВКД

ИД ВКД | ТИП Инф-ии | ИОД
--- | --- | --- 
1 | Кт, ПДн, ИИ | Ментюков
2 | Кт, ПДн | Каманин
3 | Кт, ПДн | Каманин
4 | Кт | Лазарева
5 | Кт | Лазарева
6 | ИИ | Лакия
7 | Кт, ИИ | Лакия
8 | ПДн | Николаевский
9 | Кт, ПДн | Николаевский
10 | Кт, ПДн | Ментюков

Отчет по комнатам содержащие ИИ:

ИД ВКД | ТИП Инф-ии | ИОД
--- | --- | --- 
1 | Кт, ПДн, ИИ | Ментюков
6 | ИИ | Лакия
7 | Кт, ИИ | Лакия

Отчет по  комнатам содержащие только ИИ:

ИД ВКД | ТИП Инф-ии | ИОД
--- | --- | ---
6 | ИИ | Лакия

Отчет по  комнатам содержащие Кт, ПДн:

ИД ВКД | ТИП Инф-ии | ИОД
--- | --- | --- 
1 | Кт, ПДн, ИИ | Ментюков
2 | Кт, ПДн | Каманин
3 | Кт, ПДн | Каманин
4 | Кт | Лазарева
5 | Кт | Лазарева
7 | Кт, ИИ | Лакия
8 | ПДн | Николаевский
9 | Кт, ПДн | Николаевский
10 | Кт, ПДн | Ментюков

Отчет по  комнатам содержащие только Кт, ПДн:

2 Кт, ПДн             Каманин
3 Кт, ПДн             Каманин
9 Кт, ПДн             Николаевский
10 Кт, ПДн          Ментюков


## Что нужно сделать?

- [x] Подготовить виртуалку с ис вкд
- [x] Настроить ис вкд и ввести тестовые данные (пользователи, политики, вкд и т.д.)
- [x] Добавить функцию проверки подключения к серверу баз данных
- [x] Добавить функцию перебора и отображение всех баз, коллекций и документов.
- [x] Добавить функцию поиска пользователей по имени/email/id
 <pre>  [in]:  function id_to_name (a-14):
        [out]: Ivan Ivanov              
        [in]:  function email_to_name (ivan@ivanov.com):
        [out]: Ivan Ivanov
        [in]:  function name_to_email (Ivan Ivanov):
        [out]: ivan@ivanov.com                                 </pre>
- [ ] Добавить функцию поиска всех пользователей ис вкд
- [ ] Добавить функцию поиска всех груп 
- [ ] Добавить функцию конвертации ид-группы в наименование и обратно. 
 <pre>  [in]:  function get_group_name (a-2):
        [out]: Внешние пользователи                            
        [in]:  function get_group_name (Внешние пользователи):
        [out]: a-2                                             </pre>
- [ ] Добавить функцию поиска всех вкд
- [ ] Добавить функцию переноса найденных данных csv

## На какие вопросы надо найти ответы?

<p> Q: Как понять какой иод у данной комнаты и есть ли готовый скрипт? </p>
<p> A:  - Держать отдельно базу по ИОДам или делать записи в бд vaultize или захардкорить в скрипт (конфиг).  </p>
<p> A: - Есть скрипт, но отчет по всем вкд. Требуется фильтрация. </p>

<p> Q: Есть уверенность как работают временные лицензии для внеш. и постояные лиц. для внут. пользователей? </p>
<p> A: Внут. польз. точно создают аккаунт после успешной авторизации, а внешние как работают с лицензиями незнаю. </p>

<p> Q: Есть готовая реализация скриптов от разработчика? </p>
<p> A: Да, но отчет по всем пользователям в системе и нет учета тех, кому дали доступ без создания аккаунта. Требуется фильтрация готового отчета по иоду, затем взять отчет из первой задачи и найти уник. пользователей. После вывести число тех, кто получил лицензии и тех кто на временных. </p>

<p> Q: Как быть с пользователями, которым выдана лицензия несколько раз от разных ИОД? Пример, пользователи из бух. и годовой отчетности. </p>
<p> A: Либо вести  отчетность в отдельной базе пользователей, которые состоят в неск. вкд, либо раскидать пользователей по группам с учетом, что один и тотже пользователь может находится в группе. Иначе посмотреть в сторону пользовательских групп рассылки. </p>

<p> Q: У кого из иодов более менеее прозрачное лицензирование? </p>
<pre> A: - Вероятно у НМ и УБОИЗИДБ. 
   - У НМ 50 лицензий и ~42 использованы, мало дублей с другими вкд (~2) и на врем. исп. выдано (~10).
   - УБОИЗИДБ является ФЗ проекта и владеют лицензиями DRM. У них мало вкд и уже нет временных.  </pre>

<p> Q: УПоиск тега возможен только по комнатам или по файлам с тегами, тоже можно искать? </p>
<p> A:Точно знаю, что можно определить теги у комнат. Тегам присваиваются ид, может гдето проследить их возможно и тогда получится искать документы, помеченные тегом, но это сейчас не требуется. </p>
