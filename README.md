# КПЭ 2020

## 1.  Список пользователей по комнатам одного из ИОД
 
Пример:
ИОД | ВКД | Owner | Username | Email
--- | --- | --- | --- | ---
Кузнецова | ERM:VIEW | Ereminag | User1 | user1@mail.com
Кузнецова | ERM:VIEW | Ereminag | User2 | user2@mail.com
Кузнецова | ERM:VIEW | Ereminag | User3 | user3@mail.com
Кузнецова | ERM:VIEW | Ereminag | User4 | user4@mail.com
Кузнецова | ERM:COPY | Ereminag | User1 | user1@mail.com
Кузнецова | ERM:COPY | Ereminag | User2 | user2@mail.com
Кузнецова | ERM:COPY | Ereminag | User3 | user3@mail.com


> Вопросы:
> 1.  Как понять какой иод у данной комнаты?
>  - Держать отдельно базу по ИОДам или делать записи в бд vaultize или захардкорить в скрипт (конфиг).
> 2. Есть готовая реализация?
>  - Да, но отчет по всем вкд. Требуется фильтрация.
 
Описание скрипта: скрипт подлкючается к базе MongoDB без пароля. Ищет во всех документах и коллекциях упоминание електронных адресов с доменным именем ivanov.com или petrov.com.
В найденом ищем имя и фамилию участников поиска.

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import pymongo
import re
import json

db_connect = pymongo.MongoClient('localhost', 27017, maxPoolSize=50)
for db in db_connect.database_names():
    database = db_connect[db]
    collection = database.collection_names(include_system_collections=False)
    for collect in collection:  #list the collections
        cursor = database[collect] # choosing all collection in all db
        regx = re.compile("(\W|^)[\w.\-]{0,25}@(ivanov|petrov)\.com(\W|$)", re.IGNORECASE)
        for x in cursor.find({"email": regx}):
            try:
                print x["nm"], ' found in:  ', db,'/',collect
            except:
                print 'Not found in: ',db,'/',collect
```
[out]: 
<pre>
# /opt/python2.7/bin/python2.7 test.py
Ivan Ivanov  found in:   auth / user
Not found in:  tracking / a
Not found in:  tracking / a
Not found in:  tracking / a
Not found in:  tracking / a
Not found in:  tracking / a
Not found in:  tracking / a
</pre>
---
 ## 2. Список задействованных лицензий по пользователям ИОДа**
 
Пример 1:
ИОД: Кузнецова
User1..10: email
1 тип. лицензии +
2 тип. лицензии +
3 тип. лицензии +
DRM лицензии -

Пример 2:
ИОД: Кузнецова
Лицензий: 12/50 

Пример 3:
Каманин: 
  - 360 куплено
  - 260 исп.
  - 70 раздал
  - 30 свободных

Луневский:
  - 120 врем. (среди которых без лицензий, существ. аккаунты, новые аккаунты и те кто ни разу не подключился)

Вопросы:

Есть уверенность как работают временные лицензии для внеш. и постояные лиц. для внут. пользователей?
  - Внут. польз. точно создают акк после успешной авторизации,а внешние как работают с лиц-ми незнаю. 

Есть готовая реализация?
 - Да, но отчет по всем пользователям в системе и нет учета тех, кому дали доступ без создания аккаунта. Требуется фильтрация готового отчета по иоду, затем взять отчет из первой задачи и найти уник. пользователей. После вывести число тех, кто получил лицензии и тех кто на временных.

Как быть с пользователями, которым выдана лицензия несколько раз от разных ИОД? Пример, пользователи из бух. и годовой отчетности.
  - Либо вести  отчетность в отдельной базе пользователей, которые состоят в неск. вкд, либо раскидать пользователей по группам с учетом, что один и тотже пользователь может находится в группе. Иначе посмотреть в сторону пользовательских групп рассылки.

У кого из иодов более менеее прозрачное лицензирование?
  - Вероятно у НМ и УБОИЗИДБ. 
  - У НМ 50 лицензий и ~42 использованы, мало дублей с другими вкд (~2) и на врем. исп. выдано (~10).
  - УБОИЗИДБ является ФЗ проекта и владеют лицензиями DRM. У них мало вкд и уже нет временных.

## 3. Статусы по активности пользователей ИОДа:**
### 3.1. Время последнего входа в систему (проверка, что смог авторизоватся) **
### 3.2. Доступ к ВКД (проверка, что смог авторизоватся и перешел в одну из комнат) **
### 3.3. Доступ к файлу (проверка, что смог авторизоватся и перешел в одну из комнат и скачал или просмотрел файл) **

## 4. Отчеты по комнатам содержащие информацию с определенным тегом (Кт, ПДн, ИИ)**

Допустим есть 10 ВКД
1 Кт, ПДн, ИИ     Ментюков
2 Кт, ПДн             Каманин
3 Кт, ПДн             Каманин
4 Кт                      Лазарева
5 Кт                      Лазарева
6 ИИ                     Лакия
7 Кт, ИИ               Лакия
8 ПДн                   Николаевский
9 Кт, ПДн             Николаевский
10 Кт, ПДн          Ментюков

Вывести список комнат 
содержащие ИИ:
1 Кт, ПДн, ИИ     Ментюков
6 ИИ                     Лакия
7 Кт, ИИ               Лакия

Вывести список комнат 
только с ИИ:
6 ИИ                     Лакия

Вывести список комнат 
содержащие Кт, ПДн:
1 Кт, ПДн, ИИ     Ментюков
2 Кт, ПДн             Каманин
3 Кт, ПДн             Каманин
4 Кт                      Лазарева
5 Кт                      Лазарева
7 Кт, ИИ               Лакия
8 ПДн                   Николаевский
9 Кт, ПДн             Николаевский
10 Кт, ПДн          Ментюков

Вывести список комнат 
только Кт, ПДн:
2 Кт, ПДн             Каманин
3 Кт, ПДн             Каманин
9 Кт, ПДн             Николаевский
10 Кт, ПДн          Ментюков

Поиск тега возможен только по комнатам или по файлам с тегами, тоже можно искать?
  - Точно знаю, что можно определить теги у комнат. Тегам присваиваются ид, может гдето проследить их возможно и тогда получится искать документы, помеченные тегом, но это сейчас не требуется.




## Что нужно сделать?
~~1. Подготовить виртуалку с ис вкд~~
~~2. Настроить ис вкд и ввести тестовые данные (пользователи, политики, вкд и т.д.)~~
~~3. Сделать скрипт тестого подключения к базе~~
~~4. Добавить в скрипт функцию перебора и отображение всех баз, коллекций и документов.~~
 5. Добавить функцию поиска всех пользователей системы
 6. Добавить функцию поиска всех вкд
 7. Добавить функцию переноса найденных данных в txt
 8. Добавить функцию переноса найденных данных в xlsx или csv




